import pandas as pd
import statsmodels.api as sm
from statsmodels.stats.stattools import durbin_watson, jarque_bera
import matplotlib.pyplot as plt

from io import StringIO

data = StringIO("""
LNMSFT Prima_1 Prima_2
-0.010778761 0.000512625 0.000860251
0.011937743 -0.001008278 -0.003005208
0.005116548 -0.002740234 0.000123926
0.003966722 -0.006528555 -0.006176448
-0.028247849 -0.022737255 -0.013399797
0.00182965 0.005852947 0.003801826
0.004870743 0.010249818 0.00384744
-0.005520367 -0.001232337 -0.0000864
-0.006325773 0.000222728 0.005217902
0.009953448 0.001536387 0.003353646
0.004283379 0.002581738 0.002907549
0.02173023 0.006208124 0.005597403
-0.011751293 -0.006128846 -0.003916873
0.001110521 0.008130771 0.005483846
0.017602627 0.009512135 0.002337127
0.000510334 0.003850025 0.000343017
0.014321812 0.012856445 0.00592479
0.011817782 -0.00185294 -0.001979798
0.002144011 0.007932561 0.002383986
0.005508169 -0.006325071 -0.006271514
-0.00604938 -0.002616963 -0.003076627
0.012686202 0.01739621 0.008024329
0.001268711 -0.006721152 -0.005537074
-0.005106888 0.001090776 -0.000134775
0.009612249 0.012219316 0.003683783
0.006335212 -0.003327068 -0.003979777
-0.038284655 -0.036382602 -0.030044888
-0.000823403 -0.001136052 -0.000973807
-0.000984399 0.010153824 0.010702143
-0.003096865 0.009667663 0.007152562
0.00933026 0.013272605 0.010873864
-0.002780819 -0.000646141 -0.000514042
-0.017453013 -0.015121804 -0.011225638
-0.013327919 -0.012107818 -0.010868024
-0.007869311 -0.009181126 -0.00440233
-0.006951747 -0.001663077 -0.002334683
0.01133123 0.017417481 0.012408954
0.010573407 0.012214972 0.005414489
-0.01289096 -0.019181621 -0.011274338
0.005171631 -0.000662626 0.001450774
-0.013301757 -0.016529293 -0.015639978
-0.004209828 -0.003953071 0.001465841
-0.003650077 -0.002400868 0.0010373
0.025275105 0.024109294 0.0180388
-0.004066336 -0.009011462 -0.002223205
0.010426402 0.014873795 0.009833093
-0.001236109 0.006319194 0.008621663
0.040476544 0.012594108 0.006010867
0.001142332 0.00210518 0.005191112
-0.005949926 -0.005076352 -0.002967594
-0.021625664 -0.031282884 -0.014796318
0.028671897 0.019943818 0.009067243
-0.010949712 -0.005253405 -0.004798187
-0.063801786 0.002406289 0.005153237
0.000168665 -0.002871557 -0.005167915
-0.01002454 -0.012178373 -0.00774603
0.003522456 0.013315017 0.007090564
0.002228521 0.001838989 0.003792704
0.006102949 0.004939757 0.003529367
-0.014705257 -0.013771898 -0.009618247
0.00600997 0.00962066 0.006581828
-0.001893986 -0.003686251 0.000231182
-0.005850251 0.000201639 -0.002835952
0.003660416 0.014827446 0.010264044
-0.005152825 0.003950972 -0.000180289
0.002958184 0.000614937 0.002333638
0.012445425 0.000639344 0.002265844
0.003273562 -0.004800659 -0.004451957
-0.019215964 -0.022311843 -0.017319707
-0.01036687 -0.012325659 -0.005089846
-0.015214161 -0.013709035 -0.004799048
0.004588602 0.002456911 0.0000277
-0.018176352 -0.028331606 -0.016100036
0.011298124 0.016091338 0.015621417
-0.021643662 -0.026837011 -0.017861773
0.000308841 -0.00365846 -0.012418568
0.031435031 0.014418813 0.010989142
-0.010352137 -0.026513129 -0.018088034
-0.009061059 0.006893395 0.005397071
-0.034005888 -0.040933259 -0.027451852
0.000762546 -0.001954518 -0.007704938
0.007384939 0.011996858 0.004766638
-0.011810541 -0.019875819 -0.014096739
0.025518437 0.025627104 0.020934587
0.00036024 0.002960611 0.006287271
-0.013416067 -0.017356907 -0.010819008
0.011149544 0.013885407 0.010632296
-0.002530144 -0.003446709 -0.002295634
0.01136113 0.005102008 0.000715994
0.004640853 0.022384153 0.017383825
0.005277593 0.004459364 0.001464749
-0.013220933 -0.020724542 -0.011328025
0.001563001 -0.00542946 -0.00342077
-0.030624453 -0.027498648 -0.020042914
-0.009042876 -0.001477394 0.005414879
0.017952382 0.008559551 0.00366582
-0.000130834 0.008516881 0.006597259
-0.023913751 -0.061643934 -0.049714211
-0.036213794 -0.060043377 -0.061717407
-0.00551764 0.000883618 -0.002442513
-0.009264264 -0.02183496 -0.015933421
0.096524777 0.114676059 0.090786568
-0.023684772 -0.044138711 -0.035328921
0.018446873 0.02025673 0.017822036
-0.001648932 0.006270291 0.007804921
-0.005377886 -0.000602173 -0.001837547
-0.037292726 -0.031261161 -0.022771646
-0.010359984 -0.001379135 0.001217625
-0.023828339 -0.025954563 -0.023957983
0.02121467 0.026595297 0.024698701
0.02042677 0.024591432 0.016415512
0.033901552 0.026934041 0.019948266
0.011679527 0.012447919 0.007237762
-0.00176243 -0.001075841 0.000532161
0.007335744 0.005358058 0.005677294
0.003091349 -0.000966598 0.001370567
0.073486127 0.014933017 0.006170999
0.022959599 0.014854201 0.014510896
0.002042573 -0.007561336 -0.006510373
-0.006578668 -0.008808812 -0.007831367
0.0000923 0.00262963 0.004228671
0.011061247 0.010544961 0.00567466
0.001277227 -0.0000648 -0.000820105
0.023717595 0.042446029 0.031931681
-0.000267142 0.015892144 0.007113749
0.008425023 0.007057898 0.000915511
0.000419394 -0.001911302 0.004015468
0.002512675 0.00504675 0.006872565
0.010075211 0.000118593 0.00076736
-0.001526651 -0.003901532 -0.003996087
-0.012297847 -0.014317043 -0.016375036
0.005047232 0.002700784 -0.000553287
-0.010342177 -0.010119319 -0.006839243
0.023077863 0.024246808 0.020144211
-0.007254539 -0.005237313 -0.005695096
0.002881972 0.003806836 0.003894818
0.003655993 -0.003352033 -0.000189525
0.003491162 0.00660974 0.003985318
0.002162303 0.007984032 0.005675171
0.001942083 0.003058467 -0.0000346
0.008179961 -0.008469808 -0.005399649
0.005756577 0.01181607 0.010119853
0.005025829 0.003025009 0.000811189
-0.003878479 0.006188399 0.00535965
0.003603455 -0.005148151 -0.002856023
0.013137479 0.002264476 0.003706877
-0.008198572 -0.013195519 -0.011469077
0.00876224 0.014946656 0.009240548
-0.002298419 -0.009292969 -0.008495652
0.004591568 0.001180722 -0.000417605
-0.005931265 -0.005178909 -0.002289323
0.01785391 0.009286189 0.009452309
0.008421232 0.014132427 0.010951953
0.004397491 0.002951383 -0.000111616
0.010467703 0.009575496 0.00787982
-0.003040097 0.005111581 0.005097098
0.002959684 0.004629001 0.005042744
-0.010834298 -0.008332645 -0.001227421
-0.001952927 0.009264083 0.004625516
0.015657993 0.01003806 0.008196017
-0.002247733 -0.009304368 -0.008001683
-0.002212524 0.000182622 -0.000824483
0.013778427 0.009293683 0.00593551
-0.004039847 0.000828576 0.002634077
0.003662424 -0.00229825 -0.003411311
-0.00059622 0.002550194 0.001298082
0.005550944 0.001705399 -0.004072432
-0.000395476 0.002436569 0.003080166
0.011953117 0.007348424 0.0052511
-0.003229756 0.00037035 -0.000198852
0.0000196 0.003642821 0.001289814
-0.009435426 -0.004001154 0.000528992
0.001186779 0.005967647 0.007673193
0.00985501 0.001694986 0.000589656
0.005524175 0.002280306 0.003858112
-0.002358193 0.003214685 0.0000685
0.000136576 -0.003906632 -0.003072139
0.001306285 0.001377886 -0.001358553
0.038715499 -0.000450091 -0.003810032
-0.017757485 -0.022723174 -0.016229661
0.021760708 0.019240669 0.014521203
-0.014839607 -0.006638239 -0.004978037
-0.005338716 0.011908643 0.00714717
-0.007841077 0.003347286 -0.000906122
0.00230132 0.009603938 0.007661091
-0.000517336 -0.003125465 -0.002615602
0.014215137 0.013661032 0.011173293
-0.016498441 0.001331463 0.003116492
0.003643131 -0.000222096 0.000194718
-0.004431024 -0.00415554 -0.003009637
-0.005919402 0.000205635 -0.000209117
-0.014276636 -0.014770235 -0.005983696
-0.007976487 -0.006796865 -0.002542912
-0.002930811 -0.003540774 -0.004120574
0.005912204 0.018495926 0.014963915
-0.005872542 -0.002308781 -0.004383794
-0.00441221 0.00431001 0.004017122
0.009318254 0.002018508 0.002279803
0.005706543 0.005204958 0.00304342
-0.005805217 -0.011675 -0.006527058
-0.003103352 -0.008341409 -0.007054726
0.000455234 0.010088738 0.004978821
0.005171132 0.009610894 0.008203465
-0.025864628 -0.000444676 -0.003278494
0.00644384 0.004411769 0.001995446
0.000421429 0.003591 0.00257622
0.003924793 0.000191903 0.002870668
0.001278236 0.007040029 0.008341728
0.017588567 0.00432901 -0.000591185
0.010651058 0.009226448 0.004587283
-0.012339087 -0.000770334 -0.001397091
0.001923342 -0.003365631 -0.001079023
-0.003083058 0.009253703 0.004669375
0.018473216 0.007020396 0.004765205
-0.006741729 0.006826895 0.004291997
-0.010198588 -0.009610096 -0.005625673
0.001805019 -0.003463463 -0.002959055
-0.006134627 -0.005150837 -0.005129982
0.008699208 0.004321035 0.005776159
0.006120519 0.004642845 0.002523779
0.006488813 0.002935127 0.00397417
0.003392251 0.004081903 0.003285786
-0.007668201 0.003790423 0.000509845
0.003116866 -0.002893677 -0.0000428
0.021455619 0.006941228 0.003531664
-0.008721731 -0.006813362 -0.00392703
0.001658992 0.011020314 0.00570236
-0.00467893 -0.000922347 -0.002867655
-0.022142269 -0.036381027 -0.027594293
0.006029228 0.0217273 0.015369862
-0.000934198 -0.007756496 -0.001673861
-0.000272639 0.006458371 0.003909585
-0.003551085 -0.004863318 -0.006422578
0.003843195 0.005082814 0.005148549
0.006230792 0.013492338 0.010507373
0.001682054 -0.001713324 -0.0000757
0.005548078 -0.009443092 -0.005460139
0.0000384 0.008709163 0.005702141
0.005841977 0.011293263 0.007763029
0.014993694 0.018362238 0.012106777
0.019654318 0.007898881 0.002177
-0.000959746 0.005373625 -0.00015187
-0.029590563 -0.015983008 -0.010062525
-0.015236455 0.005972085 0.002506116
-0.00150748 0.004507349 0.001610898
-0.005235817 -0.020712936 -0.011914524
-0.014038547 0.006344839 0.00353853
-0.020035323 -0.019261387 -0.011349436
-0.000563426 -0.002255602 0.001152716
""")

df = pd.read_csv(data, sep=r"\s+")
print(df)
print(df.info())

# ===========================================================
# 2. Gráfica de dispersión inicial (Y vs X)
# ===========================================================
plt.scatter(df["Prima_1"], df["LNMSFT"])
plt.xlabel("Prima_1")
plt.ylabel("LNMSFT")
plt.title("Dispersión entre LNMSFT y Prima_1")
plt.show()

plt.scatter(df["Prima_2"], df["LNMSFT"])
plt.xlabel("Prima_2")
plt.ylabel("LNMSFT")
plt.title("Dispersión entre LNMSFT y Prima_2")
plt.show()

# ===========================================================
# 3. Variables para regresión
# ===========================================================
X = df[["Prima_1","Prima_2"]]   # variables independientes
y = df["LNMSFT"]            # variable dependiente

# Agregar constante
X = sm.add_constant(X)

# ===========================================================
# 4. Ajustar modelo OLS
# ===========================================================
modelo = sm.OLS(y, X).fit()

# Imprimir resumen general
print(modelo.summary())

# ===========================================================
# 5. Prueba Durbin-Watson
# ===========================================================
dw = durbin_watson(modelo.resid)
print("\nDurbin-Watson:", round(dw, 4))

if dw < 1.5:
    print("→ Posible autocorrelación positiva")
elif dw > 2.5:
    print("→ Posible autocorrelación negativa")
else:
    print("→ No hay evidencia fuerte de autocorrelación")

# ===========================================================
# 6. Prueba Jarque-Bera
# ===========================================================
jb_stat, jb_pvalue, skew, kurtosis = jarque_bera(modelo.resid)
print("\nJarque-Bera:", round(jb_stat,4))
print("p-value:", round(jb_pvalue,4))
print("Skewness:", round(skew,4))
print("Kurtosis:", round(kurtosis,4))

if jb_pvalue > 0.05:
    print("→ No se rechaza normalidad de residuos")
else:
    print("→ Se rechaza normalidad de residuos")

# ===========================================================
# 7. Gráfico de residuos (opcional)
# ===========================================================
plt.scatter(modelo.fittedvalues, modelo.resid)
plt.axhline(y=0, color='black')
plt.xlabel("Valores ajustados")
plt.ylabel("Residuos")
plt.title("Residuos vs Ajustados")
plt.show()

# ===========================================================
# 8. Histograma de residuos (opcional) y p-plot
# ===========================================================

import scipy.stats as stats
# Histograma de los residuales
plt.hist(modelo.resid, bins=20, edgecolor='k')
plt.xlabel("Residuales")
plt.ylabel("Frecuencia")
plt.title("Histograma de los Residuales")
plt.show()

# Gráfico P-P Plot de los residuales
stats.probplot(modelo.resid, dist="norm", plot=plt)
plt.title("P-P Plot de los Residuales")
plt.show()
