import pandas as pd
import statsmodels.api as sm
from statsmodels.stats.stattools import durbin_watson, jarque_bera
import matplotlib.pyplot as plt

# ===========================================================
# 1. Datos de ejemplo (sustituye con tus datos)
# ===========================================================
from io import StringIO

data = """
MSFT    NASDAQ    US500    COBRE    LNMSFT    LNNASDQ    LNUS500    LNCOBRE
492.05  20,202.89  6,198.01  4.913    -0.001952927   0.009372416   0.004733849   0.035884116
491.09  20,393.13  6,227.42  5.0925   0.015657993    0.010146393   0.00830435    0.005971336
498.84  20,601.10  6,279.35  5.123    -0.002247733   -0.009196034  -0.007893349  -0.007936938
497.72  20,412.52  6,229.98  5.0825   -0.002212524   0.000290956   -0.00071615   0.003339229
496.62  20,418.46  6,225.52  5.0995   0.013778427    0.009402016   0.006043843   0.019035245
503.51  20,611.34  6,263.26  5.1975   -0.004039847   0.000936909   0.00274241    -0.010832875
501.48  20,630.66  6,280.46  5.1415   0.003662424    -0.002189917  -0.003302978  -0.015484433
503.32  20,585.53  6,259.75  5.0625   -0.00059622    0.002658527   0.001406415   -0.007235993
503.02  20,640.33  6,268.56  5.026    0.005550944    0.001813732   -0.003964098  0.123294635
505.82  20,677.80  6,243.76  5.6855   -0.000395476   0.002544902   0.0031885     -0.035628545
505.62  20,730.49  6,263.70  5.4865   0.011953117    0.007456757   0.005359433   0.018867633
511.7   20,885.65  6,297.36  5.591    -0.003229756   0.000478683   -9.05182E-05   0.002411684
510.05  20,895.65  6,296.79  5.6045   1.96057E-05     0.003751154   0.001398148   -0.009681833
510.06  20,974.18  6,305.60  5.5505   -0.009435426   -0.00389282   0.000637325   0.004852634
505.27  20,892.69  6,309.62  5.5775   0.001186779    0.00607598    0.007781526    -0.009276421
505.87  21,020.02  6,358.91  5.526    0.00985501     0.001803319   0.000697989    -0.002445986
510.88  21,057.96  6,363.35  5.5125   0.005524175    0.00238864    0.003966445    0.016551606
513.71  21,108.32  6,388.64  5.6045   -0.002358193    0.003323018   0.000176861    0.005870858
512.5   21,178.58  6,389.77  5.6375   0.000136576    -0.003798299   -0.002963806    0.014790304
512.57  21,098.29  6,370.86  5.7215   0.001306285    0.001486219   -0.00125022     0.016983339
513.24  21,129.67  6,362.90  5.8195   0.038715499    -0.000341758   -0.003701699    -0.003097843
533.5   21,122.45  6,339.39  5.8015   -0.017757485    -0.022614841   -0.016121328   -0.002848144
524.11  20,650.13  6,238.01  5.785    0.021760708    0.019349002    0.014629536    -0.032948291
535.64  21,053.58  6,329.94  5.5975   -0.014839607    -0.006529905   -0.004869704    0.001695748
527.75  20,916.55  6,299.19  5.607    -0.005338716    0.012016976    0.007255504    -0.00375235
524.94  21,169.42  6,345.06  5.586    -0.007841077    0.003455619    -0.000797789   -0.249053674
520.84  21,242.70  6,340.00  4.3545   0.00230132     0.009712271    0.007769424    0.018430556
522.04  21,450.02  6,389.45  4.4355   -0.000517336    -0.003017132   -0.002507268    0.000450806
521.77  21,385.40  6,373.45  4.4375   0.014215137    0.013769365    0.011281626    -0.011673505
529.24  21,681.90  6,445.76  4.386    -0.016498441    0.001439796    0.003224825    0.00613708
520.58  21,713.14  6,466.58  4.413    0.003643131    -0.000113762   0.000303051    -0.003291157
522.48  21,710.67  6,468.54  4.3985   -0.004431024    -0.004047207   -0.002901304    0.016460349
520.17  21,622.98  6,449.80  4.4715   -0.005919402    0.000313968    -0.000100783    -0.007069546
517.1   21,629.77  6,449.15  4.44     -0.014276636    -0.014661902   -0.005875363    0.019073692
509.77  21,314.95  6,411.37  4.5255   -0.007976487    -0.006688532   -0.002434579    -0.006206381
505.72  21,172.86  6,395.78  4.4975   -0.002930811    -0.003432441   -0.004012241    -0.004010254
504.24  21,100.31  6,370.17  4.4795   0.005912204     0.01860426     0.015072249    0.002897907
507.23  21,496.54  6,466.91  4.4925   -0.005872542    -0.002200447   -0.004275461    0.009636227
504.26  21,449.29  6,439.32  4.536    -0.00441221     0.004418343    0.004125455    -0.010526996
502.04  21,544.27  6,465.94  4.4885   0.009318254     0.002126841    0.002388136    0.004889442
506.74  21,590.14  6,481.40  4.5105   0.005706543     0.005313291    0.003151753    0.00022168
509.64  21,705.16  6,501.86  4.5115   -0.005805217    -0.011566667   -0.006418725    0.003540218
506.69  21,455.55  6,460.26  4.5275   -0.003103352    -0.008233076   -0.006946392    -0.000220897
505.12  21,279.63  6,415.54  4.5265   0.000455234     0.010197071    0.005087155    -0.00365186
505.35  21,497.73  6,448.26  4.51     0.005171132     0.009719227    0.008311799    -0.008573231
507.97  21,707.69  6,502.08  4.4715   -0.025864628    -0.000336343   -0.003170161    0.014982801
495     21,700.39  6,481.50  4.539    0.00644384      0.004520102    0.002103779    0.011282227
498.2   21,798.70  6,495.15  4.5905   0.000421429     0.003699333    0.002684553    -0.001133416
498.41  21,879.49  6,512.61  4.5853   0.003924793     0.000300236    0.002979001    -0.000610834
500.37  21,886.06  6,532.04  4.5825   0.001278236     0.007148362    0.008450061    0.01268516
501.01  22,043.07  6,587.47  4.641    0.017588567     0.004437343    -0.000482851   -0.002372992
509.9   22,141.10  6,584.29  4.63     0.010651058     0.009334781    0.004695616    -0.015563246
515.36  22,348.75  6,615.28  4.5585   -0.012339087    -0.000662001   -0.001288757    -0.001646633
509.04  22,333.96  6,606.76  4.551    0.001923342     -0.003257298   -0.000970689    0.001865979
510.02  22,261.33  6,600.35  4.5595   -0.003083058     0.009362036    0.004777709    0.002190821
508.45  22,470.72  6,631.96  4.5695   0.018473216     0.007128729    0.004873539    0.010557921
517.93  22,631.48  6,664.36  4.618    -0.006741729    0.006935228    0.00440033     0.008624461
514.45  22,788.98  6,693.75  4.658    -0.010198588    -0.009501763   -0.00551734     -0.001288937
509.23  22,573.47  6,656.92  4.652    0.001805019     -0.003355129   -0.002850721    0.013981764
510.15  22,497.86  6,637.97  4.7175   -0.006134627    -0.005042504   -0.005021649    -0.004993901
507.03  22,384.70  6,604.72  4.694    0.008699208     0.004429369    0.005884492    -0.013296357
511.46  22,484.07  6,643.70  4.632    0.006120519     0.004751178    0.002632113    -0.006823747
514.6   22,591.15  6,661.21  4.6005   0.006488813     0.00304346     0.004082504    0.005851772
517.95  22,660.01  6,688.46  4.6275   0.003392251     0.004190236    0.003394119    -0.004331355
519.71  22,755.16  6,711.20  4.6075   -0.007668201    0.003898757    0.000618178    0.002601064
515.74  22,844.05  6,715.35  4.6195   0.003116866     -0.002785344   6.55194E-05    0.035930736
517.35  22,780.51  6,715.79  4.7885   0.021455619     0.007049562    0.003639997    -0.011763606
528.57  22,941.67  6,740.28  4.7325   -0.008721731    -0.006705028   -0.003818696    0.002848554
523.98  22,788.36  6,714.59  4.746    0.001658992     0.011128647    0.005810693    0.03029906
524.85  23,043.38  6,753.72  4.892    -0.00467893     -0.000814014   -0.002759322    -0.007283204
522.4   23,024.63  6,735.11  4.8565   -0.022142269    -0.036272694   -0.02748596     0.00533937
510.96  22,204.43  6,552.51  4.8825   0.006029228     0.021835633    0.015478195    0.013629178
514.05  22,694.61  6,654.72  4.9495   -0.000934198    -0.007648162   -0.001565528    0.031717129
513.57  22,521.70  6,644.31  5.109    -0.000272639    0.006566705    0.004017919    -0.013994512
513.43  22,670.08  6,671.06  5.038    -0.003551085    -0.004754984   -0.006314245    0.011741046
511.61  22,562.54  6,629.07  5.0975   0.003843195     0.005191147    0.005256883    -0.000588697
513.58  22,679.97  6,664.01  5.0945   0.006230792     0.013600671    0.010615706    0.005578679
516.79  22,990.54  6,735.13  5.123    0.001682054     -0.00160499      3.2664E-05    -0.04573024
517.66  22,953.67  6,735.35  4.894    0.005548078     -0.009334758    -0.005351806   0.049821022
520.54  22,740.40  6,699.40  5.144    3.84209E-05     0.008817496    0.005810474    -0.023803622
520.56  22,941.80  6,738.44  5.023    0.005841977     0.011401596    0.007871362    -0.001693649
523.61  23,204.87  6,791.69  5.0145   0.014993694     0.018470571    0.01221511     -0.003095823
531.52  23,637.46  6,875.16  4.999    0.019654318     0.008007214    0.002285333    -0.005918661
542.07  23,827.49  6,890.89  4.9695   -0.000959746     0.005481959    -4.35367E-05   0.013292885
541.55  23,958.47  6,890.59  5.036    -0.029590563     -0.015874675    -0.009954191   -0.013997429
525.76  23,581.14  6,822.34  4.966    -0.015236455     0.006080419    0.002614449    0.00592282
517.81  23,724.96  6,840.20  4.9955   -0.00150748      0.004615683    0.001719231    0.02275974
517.03  23,834.72  6,851.97  5.1105   -0.005235817     -0.020604603    -0.01180619    0.002345354
514.33  23,348.64  6,771.55  5.1225   -0.014038547     0.006453172    0.003646863    0.004577113
507.16  23,499.80  6,796.29  5.146    -0.020035323     -0.019153054    -0.011241103   -0.000194345
497.1   23,053.99  6,720.32  5.145    -0.000563426     -0.002147269    0.001261049    0.017723446
"""

# Convertir texto a DataFrame
df = pd.read_csv(StringIO(data), sep=r"\s+", thousands=',')

# Clean numeric columns with commas and convert to float (this loop will now be skipped for NASDAQ and US500, which is fine)
for col in ["NASDAQ", "US500", "COBRE", "MSFT"]:
    if df[col].dtype == 'object': # Check if column is object type
        df[col] = df[col].str.replace(',', '', regex=False).astype(float)

print(df)

# ===========================================================
# 2. Gráfica de dispersión inicial (Y vs X)
# ===========================================================
plt.scatter(df["NASDAQ"], df["MSFT"])
plt.xlabel("NASDAQ")
plt.ylabel("MSFT")
plt.title("Dispersión entre LNMSFT y LNNASDQ")
plt.show()

plt.scatter(df["US500"], df["MSFT"])
plt.xlabel("US500")
plt.ylabel("MSFT")
plt.title("Dispersión entre MSFT y US500")
plt.show()

plt.scatter(df["COBRE"], df["MSFT"])
plt.xlabel("COBRE")
plt.ylabel("MSFT")
plt.title("Dispersión entre MSFT y COBRE")
plt.show()


# ===========================================================
# 3. Variables para regresión
# ===========================================================
X = df[["NASDAQ","US500","COBRE"]] # variables independientes
y = df["MSFT"]            # variable dependiente

# Agregar constante
X = sm.add_constant(X)


# ===========================================================
# 4. Ajustar modelo OLS
# ===========================================================
modelo = sm.OLS(y, X).fit()

# Imprimir resumen general
print(modelo.summary())

# ===========================================================
# 5. Prueba Durbin-Watson
# ===========================================================
dw = durbin_watson(modelo.resid)
print("\nDurbin-Watson:", round(dw, 4))

if dw < 1.5:
    print("→ Posible autocorrelación positiva")
elif dw > 2.5:
    print("→ Posible autocorrelación negativa")
else:
    print("→ No hay evidencia fuerte de autocorrelación")

# ===========================================================
# 6. Prueba Jarque-Bera
# ===========================================================
jb_stat, jb_pvalue, skew, kurtosis = jarque_bera(modelo.resid)
print("\nJarque-Bera:", round(jb_stat,4))
print("p-value:", round(jb_pvalue,4))
print("Skewness:", round(skew,4))
print("Kurtosis:", round(kurtosis,4))

if jb_pvalue > 0.05:
    print("→ No se rechaza normalidad de residuos")
else:
    print("→ Se rechaza normalidad de residuos")

# ===========================================================
# 7. Gráfico de residuos (opcional)
# ===========================================================
plt.scatter(modelo.fittedvalues, modelo.resid)
plt.axhline(y=0, color='black')
plt.xlabel("Valores ajustados")
plt.ylabel("Residuos")
plt.title("Residuos vs Ajustados")
plt.show()

import scipy.stats as stats

# Histograma de los residuales
plt.hist(modelo.resid, bins=20, edgecolor='k')
plt.xlabel("Residuales")
plt.ylabel("Frecuencia")
plt.title("Histograma de los Residuales")
plt.show()

# Gráfico P-P Plot de los Residuales
stats.probplot(modelo.resid, dist="norm", plot=plt)
plt.title("P-P Plot de los Residuales")
plt.show()
