import pandas as pd
import statsmodels.api as sm
from statsmodels.stats.stattools import durbin_watson, jarque_bera
import matplotlib.pyplot as plt

# ===========================================================
# 1. Datos de ejemplo (sustituye con tus datos)
# ===========================================================
from io import StringIO

data = """
LNMSFT	LNNASDQ	LNUS500	LNCOBRE
-0.010778761	0.000620958	0.000968584	-0.017637554
0.011937743	-0.000899944	-0.002896874	-0.021198841
0.005116548	-0.0026319	0.00023226	-0.012597066
0.003966722	-0.006420222	-0.006068115	0.000731083
-0.028247849	-0.022628922	-0.013291464	-0.007089628
0.00182965	0.00596128	0.00391016	0.01400839
0.004870743	0.010358151	0.003955774	0.004706459
-0.005520367	-0.001124004	2.19704E-05	0.002645186
-0.006325773	0.000331062	0.005326235	-0.006263571
0.009953448	0.00164472	0.003461979	-0.00873792
0.004283379	0.002690072	0.003015882	0.004742515
0.02173023	0.006316457	0.005705736	-0.011346428
-0.011751293	-0.006020513	-0.00380854	0.010253996
0.001110521	0.008239104	0.005592179	0.001335033
0.017602627	0.009620468	0.002445461	-0.002185528
0.000510334	0.003958358	0.00045135	0.017112975
0.014321812	0.012964778	0.006033124	-0.00035853
0.011817782	-0.001744606	-0.001871465	-0.002034102
0.002144011	0.008040894	0.00249232	0.00095774
0.005508169	-0.006216737	-0.00616318	0.018847236
-0.00604938	-0.00250863	-0.002968294	-0.001057393
0.012686202	0.017504544	0.008132662	-0.002000354
0.001268711	-0.006612819	-0.005428741	-0.004722559
-0.005106888	0.00119911	-2.64412E-05	-0.011425975
0.009612249	0.012327649	0.003792116	-0.001557353
0.006335212	-0.003218734	-0.003871444	-0.010969913
-0.038284655	-0.036274269	-0.029936555	0.00254222
-0.000823403	-0.001027719	-0.000865473	-0.019534256
-0.000984399	0.010262157	0.010810476	0.005777876
-0.003096865	0.009775996	0.007260895	-0.003807189
0.00933026	0.013380938	0.010982197	0.00625577
-0.002780819	-0.000537808	-0.000405709	0.004635851
-0.017453013	-0.015013471	-0.011117305	-0.001827375
-0.013327919	-0.011999485	-0.01075969	-0.00183072
-0.007869311	-0.009072793	-0.004293996	-0.016380685
-0.006951747	-0.001554744	-0.00222635	-0.000124185
0.01133123	0.017525814	0.012517287	0.011729254
0.010573407	0.012323305	0.005522822	0.021373005
-0.01289096	-0.019073288	-0.011166005	0.008136936
0.005171631	-0.000554293	0.001559108	0.014904463
-0.013301757	-0.01642096	-0.015531644	0.011904903
-0.004209828	-0.003844738	0.001574174	-0.001277065
-0.003650077	-0.002292534	0.001145633	0.004982918
0.025275105	0.024217627	0.018147133	0.003922478
-0.004066336	-0.008903129	-0.002114872	0.010651192
0.010426402	0.014982128	0.009941426	0.011778166
-0.001236109	0.006427527	0.008729997	-0.016459876
0.040476544	0.012702441	0.006119201	-0.006314964
0.001142332	0.002213514	0.005299445	-0.009257183
-0.005949926	-0.004968019	-0.002859261	0.001045721
-0.021625664	-0.031174551	-0.014687985	-0.002092537
0.028671897	0.020052152	0.009175576	-0.020813262
-0.010949712	-0.005145072	-0.004689854	0.003913435
-0.063801786	0.002514623	0.005261571	0.008485614
0.000168665	-0.002763223	-0.005059581	0.010971165
-0.01002454	-0.01207004	-0.007637697	-0.006638352
0.003522456	0.01342335	0.007198897	0.006173938
0.002228521	0.001947322	0.003901038	0.011086844
0.006102949	0.005048091	0.0036377	0.020574752
-0.014705257	-0.013663564	-0.009509913	0.003818084
0.00600997	0.009728993	0.006690161	0.028289179
-0.001893986	-0.003577918	0.000339515	0.025388627
-0.005850251	0.000309972	-0.002727619	-0.022777091
0.003660416	0.014935779	0.010372377	0.022245826
-0.005152825	0.004059305	-7.1956E-05	0.015502551
0.002958184	0.00072327	0.002441972	-0.024041401
0.012445425	0.000747677	0.002374178	-0.004727633
0.003273562	-0.004692326	-0.004343624	-0.006157854
-0.019215964	-0.02220351	-0.017211374	0.011207014
-0.01036687	-0.012217326	-0.004981513	-0.010881969
-0.015214161	-0.013600702	-0.004690715	-0.011330331
0.004588602	0.002565245	0.000136005	-0.013235001
-0.018176352	-0.028223272	-0.015991703	0.012796645
0.011298124	0.016199671	0.01572975	0.01241846
-0.021643662	-0.026728678	-0.017753439	-0.015382401
0.000308841	-0.003550127	-0.012310235	0.01288931
0.031435031	0.014527146	0.011097476	-0.011022101
-0.010352137	-0.026404796	-0.017979701	0.050810351
-0.009061059	0.007001728	0.005505405	0.002812062
-0.034005888	-0.040824926	-0.027343518	-0.02048929
0.000762546	-0.001846185	-0.007596605	-0.009278582
0.007384939	0.012105191	0.004874971	0.021098053
-0.011810541	-0.019767486	-0.013988405	0.017368228
0.025518437	0.025735437	0.02104292	0.015550185
0.00036024	0.003068944	0.006395604	-0.006007247
-0.013416067	-0.017248574	-0.010710674	0.012785562
0.011149544	0.01399374	0.010740629	0.011528372
-0.002530144	-0.003338376	-0.002187301	0.01650806
0.01136113	0.005210342	0.000824327	0.002350177
0.004640853	0.022492486	0.017492158	0.000293384
"""

df = pd.read_csv(StringIO(data), sep="\t")
print(df)


# ===========================================================
# 2. Gráfica de dispersión inicial (Y vs X)
# ===========================================================
plt.scatter(df["LNNASDQ"], df["LNMSFT"])
plt.xlabel("LNNASDQ")
plt.ylabel("LNMSFT")
plt.title("Dispersión entre LNMSFT y LNNASDQ")
plt.show()

plt.scatter(df["LNUS500"], df["LNMSFT"])
plt.xlabel("LNUS500")
plt.ylabel("LNMSFT")
plt.title("Dispersión entre LNMSFT y LNUS500")
plt.show()

plt.scatter(df["LNCOBRE"], df["LNMSFT"])
plt.xlabel("LNCOBRE")
plt.ylabel("LNMSFT")
plt.title("Dispersión entre LNMSFT y LNCOBRE")
plt.show()


# ===========================================================
# 3. Variables para regresión
# ===========================================================
X = df[["LNNASDQ","LNUS500","LNCOBRE"]]   # variables independientes
y = df["LNMSFT"]            # variable dependiente

# Agregar constante
X = sm.add_constant(X)


# ===========================================================
# 4. Ajustar modelo OLS
# ===========================================================
modelo = sm.OLS(y, X).fit()

# Imprimir resumen general
print(modelo.summary())

# ===========================================================
# 5. Prueba Durbin-Watson
# ===========================================================
dw = durbin_watson(modelo.resid)
print("\nDurbin-Watson:", round(dw, 4))

if dw < 1.5:
    print("→ Posible autocorrelación positiva")
elif dw > 2.5:
    print("→ Posible autocorrelación negativa")
else:
    print("→ No hay evidencia fuerte de autocorrelación")

# ===========================================================
# 6. Prueba Jarque-Bera
# ===========================================================
jb_stat, jb_pvalue, skew, kurtosis = jarque_bera(modelo.resid)
print("\nJarque-Bera:", round(jb_stat,4))
print("p-value:", round(jb_pvalue,4))
print("Skewness:", round(skew,4))
print("Kurtosis:", round(kurtosis,4))

if jb_pvalue > 0.05:
    print("→ No se rechaza normalidad de residuos")
else:
    print("→ Se rechaza normalidad de residuos")

# ===========================================================
# 7. Gráfico de residuos (opcional)
# ===========================================================
plt.scatter(modelo.fittedvalues, modelo.resid)
plt.axhline(y=0, color='black')
plt.xlabel("Valores ajustados")
plt.ylabel("Residuos")
plt.title("Residuos vs Ajustados")
plt.show()

# ===========================================================
# 8. Histograma de residuos (opcional) y p-plot
# ===========================================================

import scipy.stats as stats
# Histograma de los residuales
plt.hist(modelo.resid, bins=20, edgecolor='k')
plt.xlabel("Residuales")
plt.ylabel("Frecuencia")
plt.title("Histograma de los Residuales")
plt.show()

# Gráfico P-P Plot de los residuales
stats.probplot(modelo.resid, dist="norm", plot=plt)
plt.title("P-P Plot de los Residuales")
plt.show()

